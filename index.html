<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzQCrrnyAbszf4T2Si6SJehADQnfvIvL01n3Fm4ckBpnjF0LMJgYTo8mHUWHVJKYAGU/exec';

/* ===== –¶–í–ï–¢ –ù–ò–ö–ê ===== */
function nickColor(nick) {
  let hash = 0;
  for (let i = 0; i < nick.length; i++) {
    hash = nick.charCodeAt(i) + ((hash << 5) - hash);
  }
  return `hsl(${Math.abs(hash) % 360}, 70%, 60%)`;
}

/* ===== –†–ï–ù–î–ï–† ===== */
function render(text) {
  const lines = text.split('\n');
  let html = '';
  let currentDay = '';

  lines.forEach(line => {
    const match = line.match(/^\[(\d\d:\d\d:\d\d)\]\s(.+?):$/);

    if (match) {
      const time = match[1];
      const nick = match[2];

      const today = new Date().toLocaleDateString();
      if (currentDay !== today) {
        currentDay = today;
        html += `<div class="day">‚îÄ‚îÄ ${today} ‚îÄ‚îÄ</div>`;
      }

      html += `<span class="time">[${time}]</span> ` +
              `<span class="nick" style="color:${nickColor(nick)}">${nick}</span>:\n`;
    } else {
      html += line + '\n';
    }
  });

  logEl.innerHTML = html;
  logEl.scrollTop = logEl.scrollHeight;
}

/* ===== –û–¢–ü–†–ê–í–ö–ê (–í–ê–ñ–ù–û!) ===== */
function send() {
  const nick = nickEl.value.trim();
  const message = msgEl.value.trim();
  if (!nick || !message) return;

  fetch(API_URL, {
    method: 'POST',
    mode: 'no-cors',   // üî• –ö–õ–Æ–ß–ï–í–û
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ nick, message })
  });

  msgEl.value = '';
}

/* ===== –ó–ê–ì–†–£–ó–ö–ê ===== */
function loadChat() {
  fetch(API_URL)
    .then(r => r.text())
    .then(render)
    .catch(() => {
      logEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
    });
}

const logEl = document.getElementById('log');
const nickEl = document.getElementById('nick');
const msgEl  = document.getElementById('message');

setInterval(loadChat, 3000);
loadChat();
</script>
