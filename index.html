<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Night Chat</title>

<style>
body {
  background:#000;
  color:#eee;
  font-family:monospace;
  padding:20px;
}

#terminal {
  max-width:900px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}

#log {
  border:1px solid #333;
  padding:10px;
  height:60vh;
  overflow:auto;
  white-space:pre-wrap;
}

.day {
  text-align:center;
  color:#6cf;
  margin:10px 0;
}

.time {
  color:#888;
}

.nick {
  font-weight:bold;
}

.system {
  color:#f6a;
  font-style:italic;
}

input, textarea, button {
  width:100%;
  box-sizing:border-box;
  background:#000;
  color:#eee;
  border:1px solid #333;
  padding:8px;
  font-family:monospace;
  font-size:14px;
}

input {
  height:36px;
}

textarea {
  height:80px;
  resize:none;
}

button {
  height:36px;
  cursor:pointer;
}

button:disabled {
  color:#555;
  border-color:#222;
}

button:hover:not(:disabled) {
  background:#111;
}

#status {
  height:16px;
  font-size:12px;
  color:#888;
}

.nick-row {
  display:flex;
  gap:10px;
}

.nick-row input {
  flex:1;
}

.nick-row button {
  width:140px;
}
</style>
</head>
<body>

<div id="terminal">
  <div id="log">loading...</div>

  <div class="nick-row">
    <input id="nick" placeholder="nick">
    <button id="changeNick">change nick</button>
  </div>

  <textarea id="msg" placeholder="message (max 500 chars)"></textarea>
  <button id="sendBtn">send</button>
  <div id="status"></div>
</div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbykZXorAKIu6joMRIryLNejS0aDNUoHHHx8eErP1LgbUVVrW0P3AfTRFvemj63zFWJ8/exec';
const FLOOD_DELAY = 3000;
const MAX_LEN = 500;

let lastSendTime = 0;
let lastMessage = '';
let pendingNickChange = null;

function nickColor(nick) {
  let hash = 0;
  for (let i = 0; i < nick.length; i++) {
    hash = nick.charCodeAt(i) + ((hash << 5) - hash);
  }
  return `hsl(${Math.abs(hash) % 360}, 70%, 60%)`;
}

function render(text) {
  const lines = text.split('\n');
  let html = '';
  let currentDay = '';

  for (let line of lines) {
    const m = line.match(/^\[(\d{4}-\d{2}-\d{2}) (\d{2}:\d{2}:\d{2})\] (.+?):$/);

    if (m) {
      const date = m[1];
      const time = m[2];
      const nick = m[3];

      if (currentDay !== date) {
        currentDay = date;
        html += `<div class="day">── ${date} ──</div>`;
      }

      if (nick === 'system') {
        html += `<span class="time">[${time}]</span> <span class="system">system</span>:\n`;
      } else {
        html += `<span class="time">[${time}]</span> <span class="nick" style="color:${nickColor(nick)}">${nick}</span>:\n`;
      }
    } else {
      html += line + '\n';
    }
  }

  log.innerHTML = html;
  log.scrollTop = log.scrollHeight;
}

function load() {
  fetch(API).then(r => r.text()).then(render);
}

function initNick() {
  const saved = localStorage.getItem('chat_nick');
  if (saved) {
    nick.value = saved;
    nick.disabled = true;
  }
}

function unlockNick() {
  const oldNick = localStorage.getItem('chat_nick');
  if (oldNick) pendingNickChange = oldNick;
  nick.disabled = false;
  localStorage.removeItem('chat_nick');
}

function sendSystem(text) {
  fetch(API, {
    method:'POST',
    mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ nick:'system', message:text })
  });
}

function send() {
  const now = Date.now();
  const nickVal = nick.value.trim();
  const msgVal = msg.value.trim();

  if (!nickVal) {
    status.textContent = 'set nick first';
    return;
  }

  if (!msgVal) {
    status.textContent = 'empty message';
    return;
  }

  if (msgVal.length > MAX_LEN) {
    status.textContent = 'message too long';
    return;
  }

  if (msgVal === lastMessage) {
    status.textContent = 'duplicate blocked';
    return;
  }

  if (now - lastSendTime < FLOOD_DELAY) {
    status.textContent = 'slow down';
    return;
  }

  if (pendingNickChange && pendingNickChange !== nickVal) {
    sendSystem(`${pendingNickChange} поменял ник на ${nickVal}`);
    pendingNickChange = null;
  }

  localStorage.setItem('chat_nick', nickVal);
  nick.disabled = true;

  lastSendTime = now;
  lastMessage = msgVal;
  sendBtn.disabled = true;
  status.textContent = 'sending...';

  fetch(API, {
    method:'POST',
    mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ nick:nickVal, message:msgVal })
  });

  msg.value = '';

  setTimeout(() => {
    sendBtn.disabled = false;
    status.textContent = '';
  }, FLOOD_DELAY);
}

changeNick.onclick = unlockNick;
sendBtn.onclick = send;

msg.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});

initNick();
setInterval(load, 3000);
load();
</script>

</body>
</html>


