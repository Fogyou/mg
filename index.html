<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Console Chat</title>

<style>
  body {
    background: #000;
    color: #eee;
    font-family: monospace;
    margin: 0;
    padding: 0;
    height: 100vh;
    font-size: 14px;
  }

  #terminal {
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  #log {
    flex: 1;
    border: 1px solid #333;
    padding: 15px;
    overflow-y: auto;
    background: #000;
    white-space: pre-wrap;
    line-height: 1.4;
  }

  .day {
    color: #6cf;
    margin: 10px 0;
    text-align: center;
  }

  .time {
    color: #888;
  }

  .nick {
    font-weight: bold;
  }

  input, textarea, button {
    width: 100%;
    background: #000;
    color: #eee;
    border: 1px solid #333;
    padding: 8px;
    font-family: monospace;
    font-size: 14px;
    box-sizing: border-box;
  }

  textarea {
    resize: none;
  }

  button {
    cursor: pointer;
  }

  button:hover {
    background: #111;
  }

  .input-block {
    padding: 10px;
    border-top: 1px solid #333;
  }
</style>
</head>
<body>

<div id="terminal">
  <div id="log">Загрузка...</div>

  <div class="input-block">
    <input id="nick" placeholder="nick" maxlength="32">
    <textarea id="message" rows="3" placeholder="message" maxlength="2000"></textarea>
    <button onclick="send()">send</button>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzQCrrnyAbszf4T2Si6SJehADQnfvIvL01n3Fm4ckBpnjF0LMJgYTo8mHUWHVJKYAGU/exec';

/* ===== ЭКРАНИРОВАНИЕ ===== */
function escapeHTML(str) {
  return str.replace(/[&<>"']/g, c => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  })[c]);
}


function nickColor(nick) {
  let hash = 0;
  for (let i = 0; i < nick.length; i++) {
    hash = nick.charCodeAt(i) + ((hash << 5) - hash);
  }
  return `hsl(${hash % 360}, 70%, 60%)`;
}

/* ===== РЕНДЕР ===== */
function render(text) {
  const lines = text.split('\n');
  let html = '';
  let currentDay = '';

  lines.forEach(line => {
    const match = line.match(/^\[(\d\d:\d\d:\d\d)\]\s(.+?):$/);

    if (match) {
      const time = escapeHTML(match[1]);
      const nick = escapeHTML(match[2]);
      const today = new Date().toLocaleDateString();

      if (currentDay !== today) {
        currentDay = today;
        html += `<div class="day">── ${today} ──</div>`;
      }

      html += `<span class="time">[${time}]</span> ` +
              `<span class="nick" style="color:${nickColor(nick)}">${nick}</span>:\n`;
    } else {
      html += escapeHTML(line) + '\n';
    }
  });

  logEl.innerHTML = html;
  logEl.scrollTop = logEl.scrollHeight;
}


function send() {
  const nick = nickEl.value.trim().slice(0, 32);
  const message = msgEl.value.trim().slice(0, 2000);

  if (!nick || !message) return;

  fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ nick, message })
  });

  msgEl.value = '';
}


function loadChat() {
  fetch(API_URL)
    .then(r => r.text())
    .then(render)
    .catch(() => {});
}

const logEl = doc
