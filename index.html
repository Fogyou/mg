<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Console Chat</title>

<style>
body {
  background:#000;
  color:#eee;
  font-family:monospace;
  padding:20px;
}

#log {
  border:1px solid #333;
  padding:10px;
  height:60vh;
  overflow:auto;
  white-space:pre-wrap;
}

.day {
  text-align:center;
  color:#6cf;
  margin:10px 0;
}

.time {
  color:#888;
}

.nick {
  font-weight:bold;
}

input, textarea, button {
  width:100%;
  background:#000;
  color:#eee;
  border:1px solid #333;
  margin-top:10px;
  padding:6px;
  font-family:monospace;
}

button:hover {
  background:#111;
}
</style>
</head>
<body>

<div id="log">loading...</div>

<input id="nick" placeholder="nick">
<textarea id="msg" rows="3" placeholder="message"></textarea>
<button onclick="send()">send</button>

<script>
const API = 'https://script.google.com/macros/s/AKfycbykZXorAKIu6joMRIryLNejS0aDNUoHHHx8eErP1LgbUVVrW0P3AfTRFvemj63zFWJ8/exec';


function nickColor(nick) {
  let hash = 0;
  for (let i = 0; i < nick.length; i++) {
    hash = nick.charCodeAt(i) + ((hash << 5) - hash);
  }
  return `hsl(${Math.abs(hash) % 360}, 70%, 60%)`;
}


function render(text) {
  const lines = text.split('\n');
  let html = '';
  let currentDay = '';

  for (let line of lines) {


    const m = line.match(/^\[(\d{4}-\d{2}-\d{2}) (\d{2}:\d{2}:\d{2})\] (.+?):$/);

    if (m) {
      const date = m[1];
      const time = m[2];
      const nick = m[3];

      if (currentDay !== date) {
        currentDay = date;
        html += `<div class="day">── ${date} ──</div>`;
      }

      html += `<span class="time">[${time}]</span> `
           + `<span class="nick" style="color:${nickColor(nick)}">${nick}</span>:\n`;

    } else {
     
      html += line + '\n';
    }
  }

  log.innerHTML = html;
  log.scrollTop = log.scrollHeight;
}


function load() {
  fetch(API)
    .then(r => r.text())
    .then(render);
}


function send() {
  if (!msg.value.trim()) return;

  fetch(API, {
    method: 'POST',
    mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      nick: nick.value || 'anon',
      message: msg.value
    })
  });

  msg.value = '';
}

setInterval(load, 3000);
load();
</script>

</body>
</html>
