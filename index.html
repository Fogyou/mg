<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Console Chat</title>
<style>
body {
  background:#000;
  color:#eee;
  font-family:monospace;
  padding:20px;
}
#log {
  border:1px solid #333;
  height:60vh;
  overflow:auto;
  padding:10px;
  white-space:pre-wrap;
}
input, textarea, button {
  width:100%;
  background:#000;
  color:#eee;
  border:1px solid #333;
  margin-top:10px;
  padding:6px;
}
</style>
</head>
<body>

<div id="log">Loading...</div>

<div id="nickBox" style="display:none">
  <input id="nickInput" placeholder="Choose your nick">
  <button onclick="saveNick()">Save nick</button>
</div>

<div id="chatBox" style="display:none">
  <textarea id="msg" rows="3"></textarea>
  <button onclick="send()">Send</button>
</div>

<script>
const API = 'https://script.google.com/macros/library/d/1XlEngZolAjlTyJ5ZbnO5Qp0WMac_DMTx5eGJAsmkAzVWFg-qOEgnJKXN/1';

function check() {
  fetch(API)
    .then(r=>r.json())
    .then(d=>{
      if (!d.auth) {
        document.getElementById('log').textContent =
          'Please login via Google and reload';
        return;
      }
      if (d.needNick) {
        nickBox.style.display='block';
      } else {
        chatBox.style.display='block';
        load();
      }
    });
}

function saveNick() {
  fetch(API,{
    method:'POST',
    mode:'no-cors',
    body:JSON.stringify({setNick:nickInput.value})
  }).then(()=>location.reload());
}

function send() {
  fetch(API,{
    method:'POST',
    mode:'no-cors',
    body:JSON.stringify({message:msg.value})
  });
  msg.value='';
}

function load() {
  fetch(API)
    .then(r=>r.text())
    .then(t=>{
      log.textContent=t;
      log.scrollTop=log.scrollHeight;
    });
}

setInterval(load,3000);
check();
</script>

</body>
</html>
